name: Sync Upstream

permissions: write-all

on:
  schedule:
    # 北京时间每天 12:00 和 00:00 运行
    # 对应 UTC 时间为 04:00 和 16:00
    - cron: '0 4,16 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  sync_with_upstream:
    name: Sync with Upstream and Trigger Build
    runs-on: ubuntu-latest
    if: ${{ github.repository != 'dani-garcia/vaultwarden' }}

    steps:
    # 1. 检出代码
    - name: Checkout target repo
      uses: actions/checkout@v3
      with:
        # 必须使用 PAT (Personal Access Token)
        # 否则本次 Push 无法触发你的“构建二进制”工作流
        token: ${{ secrets.ACTION_SYNC_TOKEN }}
        ref: main
        fetch-depth: 0 # 获取完整历史以便合并

    # 2. 配置 Git 用户
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"

    # 3. 执行合并逻辑（核心步骤）
    - name: Merge Upstream (Protecting .github)
      run: |
        # 添加官方仓库作为 upstream
        git remote add upstream https://github.com/dani-garcia/vaultwarden.git
        git fetch upstream main

        echo "正在合并官方代码..."
        
        # 尝试合并，参数 --no-commit 让我们有机会在提交前修改文件
        # || true 允许合并存在冲突时不立即报错（我们将在下一步处理 .github）
        git merge upstream/main --no-commit --allow-unrelated-histories || true

        echo "正在恢复本地 .github 目录..."
        # 关键命令：强制将 .github 目录重置为当前仓库的版本（HEAD）
        # 这会丢弃 upstream 对 .github 目录的所有更改（包括新增、修改、删除）
        git checkout HEAD -- .github

        # 检查是否除了 .github 之外还有未解决的冲突
        # grep -q 用于静默检查文件中是否包含冲突标记
        if git grep -Iq "<<<<<<< HEAD" .; then
            echo "Error: 在 .github 目录之外检测到代码冲突，无法自动合并。"
            echo "请手动解决冲突。"
            git merge --abort
            exit 1
        fi

        # 提交更改
        # 如果没有更改（例如官方没更新），commit 会失败，所以加了 || echo
        git commit -m "Sync from upstream (preserving local .github config)" || echo "No changes to commit"

    # 4. 推送更改
    - name: Push changes
      run: |
        git push origin main
