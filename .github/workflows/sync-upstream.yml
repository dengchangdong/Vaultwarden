name: Sync Upstream

permissions: write-all

on:
  schedule:
    # 北京时间每天 12:00 和 00:00 运行
    # 对应 UTC 时间为 04:00 和 16:00
    - cron: '0 4,16 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  sync_with_upstream:
    name: Sync with Upstream and Trigger Build
    runs-on: ubuntu-latest
    if: ${{ github.repository != 'dani-garcia/vaultwarden' }}

    steps:
    # 1. 检出代码
    - name: Checkout target repo
      uses: actions/checkout@v3
      with:
        # 必须使用 PAT (Personal Access Token)
        # 否则本次 Push 无法触发你的“构建二进制”工作流
        token: ${{ secrets.ACTION_SYNC_TOKEN }}
        ref: main
        fetch-depth: 0 # 获取完整历史以便合并

    # 2. 配置 Git 用户
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"

    # 3. 执行合并逻辑
    - name: Merge Upstream (Protecting .github)
      run: |
        git remote add upstream https://github.com/dani-garcia/vaultwarden.git
        git fetch upstream main

        echo ">>> 正在合并官方代码..."
        # 尝试合并，允许失败
        git merge upstream/main --no-commit --allow-unrelated-histories || true

        echo ">>> 正在强制恢复本地 .github 目录..."
        # 1. 把工作区的 .github 目录强制恢复成你本地的样子
        git checkout HEAD -- .github

        echo ">>> 正在标记 .github 冲突为已解决..."
        # 2. 【关键修正】告诉 Git 索引：.github 下的状态就是最终结果
        # 对于你删除的文件，这一步会确认删除；对于你保留的文件，这一步确认保留。
        git add .github

        echo ">>> 检查是否存在其他冲突..."
        # 3. 检查除 .github 以外的文件是否还有未解决的冲突
        # 我们列出所有包含冲突标记的文件，并过滤掉 .github 目录
        CONFLICT_FILES=$(git grep -Il "<<<<<<< HEAD" . | grep -v "^.github/" || true)

        if [ -n "$CONFLICT_FILES" ]; then
            echo "Error: 检测到以下文件存在无法自动解决的冲突："
            echo "$CONFLICT_FILES"
            echo "请手动解决上述冲突。"
            git merge --abort
            exit 1
        fi

        echo ">>> 提交更改..."
        # 提交更改。如果没有东西可提交（比如官方没更新），忽略错误
        git commit -m "Sync from upstream (preserving local .github config)" || echo "No changes to commit"

    # ... 后面的步骤不变 (Push changes) ...
